// Risk Score vs Salary Scatter Plot - Scroll-Driven Version
let techJobVulnerabilityScatterViz = null;
let scatterData = null;

function createTechJobVulnerabilityScatter() {
    // Clear existing visualization
    d3.select("#tech-job-vulnerability-scatter").selectAll("*").remove();

    const dataPromise = scatterData ? Promise.resolve(scatterData) : d3.csv("data/Data/fig_4.2.25.csv");
    
    dataPromise.then(function(data) {
        // Parse data
        data.forEach(function(d) {
            d.riskScore = parseFloat(d.pct_occ_scaled);
            d.salary = parseFloat(d.MedianSalary);
        });

        // Cache data
        if (!scatterData) {
            scatterData = data;
        }

        // Filter out any invalid data points
        const validData = data.filter(d => !isNaN(d.riskScore) && !isNaN(d.salary));
        
        console.log(`Total jobs loaded: ${data.length}, Valid data points: ${validData.length}`);

        // Set up dimensions
        const margin = { top: 80, right: 40, bottom: 100, left: 80 };
        const baseWidth = 900;
        const width = baseWidth - margin.left - margin.right;
        const height = 650 - margin.top - margin.bottom;
        const svgWidth = baseWidth;
        const svgHeight = height + margin.top + margin.bottom;

        // Create SVG
        const svg = d3.select("#tech-job-vulnerability-scatter")
            .append("svg")
            .attr("width", "100%")
            .attr("height", svgHeight)
            .attr("viewBox", `0 0 ${svgWidth} ${svgHeight}`)
            .attr("preserveAspectRatio", "xMidYMid meet");

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("position", "absolute")
            .style("background-color", "#2c3e50")
            .style("color", "#F0EEE6")
            .style("padding", "4px 8px")
            .style("border-radius", "3px")
            .style("font-size", "10px")
            .style("font-family", "'Merriweather', serif")
            .style("pointer-events", "none")
            .style("z-index", "1000");

        // Scales
        const xScale = d3.scaleLinear()
            .domain(d3.extent(validData, d => d.riskScore))
            .range([0, width])
            .nice();

        const yScale = d3.scaleLinear()
            .domain(d3.extent(validData, d => d.salary))
            .range([height, 0])
            .nice();

        // Color scale matching industry-outlook.js
        const maxRisk = d3.max(validData, d => d.riskScore);
        const minRisk = d3.min(validData, d => d.riskScore);
        const colorScale = d3.scaleLinear()
            .domain([minRisk, maxRisk])
            .range([0, 1]);
        
        const colorInterpolator = d3.scaleSequential()
            .domain([0, 1])
            .interpolator(t => {
                if (t < 0.4) {
                    return d3.interpolateRgb("#6ba84f", "#2d5016")(t / 0.4);
                } else if (t < 0.5) {
                    return d3.interpolateRgb("#2d5016", "#d3d3d3")((t - 0.4) / 0.1);
                } else {
                    const redT = (t - 0.5) / 0.5;
                    if (redT < 0.33) {
                        return d3.interpolateRgb("#d3d3d3", "#f4a582")(redT / 0.33);
                    } else if (redT < 0.66) {
                        return d3.interpolateRgb("#f4a582", "#d6604d")((redT - 0.33) / 0.33);
                    } else {
                        return d3.interpolateRgb("#d6604d", "#b2182b")((redT - 0.66) / 0.34);
                    }
                }
            });

        // Add grid lines first
        g.append("g")
            .attr("class", "grid")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale)
                .ticks(8)
                .tickSize(-height)
                .tickFormat(""))
            .selectAll("line")
            .attr("stroke", "#e0e0e0")
            .attr("stroke-width", 1);

        g.append("g")
            .attr("class", "grid")
            .call(d3.axisLeft(yScale)
                .ticks(8)
                .tickSize(-width)
                .tickFormat(""))
            .selectAll("line")
            .attr("stroke", "#e0e0e0")
            .attr("stroke-width", 1);

        // Create circles
        const circles = g.selectAll("circle")
            .data(validData)
            .enter()
            .append("circle")
            .attr("cx", d => xScale(d.riskScore))
            .attr("cy", d => yScale(d.salary))
            .attr("r", 4)
            .attr("fill", d => colorInterpolator(colorScale(d.riskScore)))
            .attr("stroke", "#fff")
            .attr("stroke-width", 0.5)
            .on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 1);
                tooltip.html(`${d.Title}<br/>Risk Score: ${d.riskScore.toFixed(2)}<br/>Salary: $${d.salary.toLocaleString()}`);
                
                d3.select(this)
                    .attr("stroke-width", 2)
                    .attr("stroke", "#333")
                    .attr("r", 6);
            })
            .on("mousemove", function(event) {
                tooltip
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 60) + "px")
                    .style("transform", "translateX(-50%)");
            })
            .on("mouseout", function() {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
                
                d3.select(this)
                    .attr("stroke-width", 0.5)
                    .attr("stroke", "#fff")
                    .attr("r", 4);
            });

        // Add x-axis
        const xAxis = d3.axisBottom(xScale)
            .ticks(8);

        g.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis)
            .selectAll("text")
            .attr("font-size", "11px")
            .attr("font-family", "'Merriweather', serif")
            .attr("fill", "#2c3e50");

        // Add x-axis label
        const xAxisLabel = svg.append("text")
            .attr("class", "axis-label")
            .attr("x", width / 2 + margin.left)
            .attr("y", margin.top + height + 40)
            .attr("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-family", "'Merriweather', serif")
            .attr("fill", "#2c3e50");
        
        xAxisLabel.append("tspan")
            .attr("font-weight", "600")
            .text("Risk Score");
        
        xAxisLabel.append("tspan")
            .attr("font-weight", "400")
            .attr("font-style", "italic")
            .text(" (Higher risk score means more vulnerable)");

        // Add y-axis
        const yAxis = d3.axisLeft(yScale)
            .ticks(8)
            .tickFormat(d => "$" + (d / 1000) + "K");

        g.append("g")
            .attr("class", "y-axis")
            .call(yAxis)
            .selectAll("text")
            .attr("font-size", "11px")
            .attr("font-family", "'Merriweather', serif")
            .attr("fill", "#2c3e50");

        g.select(".y-axis").select(".domain")
            .attr("stroke", "none");

        g.append("text")
            .attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("y", -60)
            .attr("x", -height / 2)
            .attr("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-family", "'Merriweather', serif")
            .attr("font-weight", "600")
            .attr("fill", "#2c3e50")
            .text("Median Salary");

        // Add title
        svg.append("text")
            .attr("x", width / 2 + margin.left)
            .attr("y", 30)
            .attr("text-anchor", "middle")
            .attr("font-size", "16px")
            .attr("font-family", "'Merriweather', serif")
            .attr("font-weight", "600")
            .attr("fill", "#2c3e50")
            .text("Job Vulnerability and Salary");

        techJobVulnerabilityScatterViz = { svg, g, xScale, yScale, circles };
    }).catch(function(error) {
        console.error("Error loading CSV:", error);
    });
}

// Initialize on load
$(document).ready(function() {
    setTimeout(createTechJobVulnerabilityScatter, 500);
});

