// Tech Job Vulnerability Visualizations - Combined Scroll-Driven Version
// Contains both bubble chart and scatter plot visualizations

// ============================================================================
// BUBBLE CHART VISUALIZATION
// ============================================================================
const techScrollTheme = window.aiVizTheme || {};
const techScrollTextPrimary = techScrollTheme.palette?.textPrimary || "#f6f7ff";
const techScrollTextMuted = techScrollTheme.palette?.textMuted || "#9da7c2";
let techJobVulnerabilityViz = null;
let techJobVulnerabilityData = null;

function createTechJobVulnerability() {
    // Clear existing visualization
    d3.select("#tech-job-vulnerability").selectAll("*").remove();

    const dataPromise = techJobVulnerabilityData ? Promise.resolve(techJobVulnerabilityData) : d3.csv("data/Data/fig_4.2.25.csv");
    
    dataPromise.then(function(data) {
        // Parse data
        data.forEach(function(d) {
            d.riskScore = parseFloat(d.pct_occ_scaled);
            d.salary = parseFloat(d.MedianSalary);
        });

        // Cache data
        if (!techJobVulnerabilityData) {
            techJobVulnerabilityData = data;
        }

        // Sort by risk score (descending) and take top 50
        const top50 = data.sort((a, b) => b.riskScore - a.riskScore).slice(0, 50);

        // Set up dimensions
        const margin = { top: 110, right: 40, bottom: 80, left: 40 };
        const baseWidth = 900;
        const width = baseWidth - margin.left - margin.right;
        const height = 700 - margin.top - margin.bottom;
        const svgWidth = baseWidth;
        const svgHeight = height + margin.top + margin.bottom;

        // Create SVG
        const svg = d3.select("#tech-job-vulnerability")
            .append("svg")
            .attr("width", "100%")
            .attr("height", svgHeight)
            .attr("viewBox", `0 0 ${svgWidth} ${svgHeight}`)
            .attr("preserveAspectRatio", "xMidYMid meet");

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("position", "fixed")
            .style("padding", "6px 10px")
            .style("border-radius", "8px")
            .style("font-size", "11px")
            .style("font-family", "'Stack Sans Notch', serif")
            .style("pointer-events", "none")
            .style("z-index", "1000");

        if (techScrollTheme.styleTooltip) {
            techScrollTheme.styleTooltip(tooltip);
        }

        // Helper function to calculate text width
        const getTextWidth = (text, fontSize) => {
            const tempSvg = d3.select("body")
                .append("svg")
                .style("position", "absolute")
                .style("visibility", "hidden")
                .style("width", 0)
                .style("height", 0);
            const temp = tempSvg.append("text")
                .attr("font-size", fontSize + "px")
                .attr("font-weight", "300")
                .text(text);
            const width = temp.node().getBBox().width;
            tempSvg.remove();
            return width;
        };

        // Helper function to calculate optimal font size to fit in circle
        const calculateOptimalFontSize = (text, radius) => {
            const maxWidth = radius * 1.8;
            let fontSize = Math.max(8, Math.min(14, radius / 3));
            let textWidth = getTextWidth(text, fontSize);
            
            while (textWidth > maxWidth && fontSize > 6) {
                fontSize -= 0.5;
                textWidth = getTextWidth(text, fontSize);
            }
            
            return { fontSize, fits: textWidth <= maxWidth };
        };

        // Scale for circle radius based on risk score
        const maxRisk = d3.max(top50, d => d.riskScore);
        const minRisk = d3.min(top50, d => d.riskScore);
        const radiusScale = d3.scaleSqrt()
            .domain([minRisk, maxRisk])
            .range([5, 90]);

        // Create a force simulation to position circles
        const simulation = d3.forceSimulation(top50)
            .force("x", d3.forceX(width / 2).strength(0.05))
            .force("y", d3.forceY(height / 2).strength(0.05))
            .force("collision", d3.forceCollide().radius(d => radiusScale(d.riskScore) + 2))
            .force("charge", d3.forceManyBody().strength(-50));

        // Pre-calculate font sizes and fit status
        top50.forEach(function(d) {
            const radius = radiusScale(d.riskScore);
            const textInfo = calculateOptimalFontSize(d.Title, radius);
            d.fontSize = textInfo.fontSize;
            d.textFits = textInfo.fits;
        });

        // Mark the top 5 largest circles
        top50.forEach(function(d, i) {
            d.isTop5 = i < 5;
        });

        const colorInterpolator = d3.scaleLinear()
            .domain([minRisk, maxRisk])
            .range([
                techScrollTheme.palette?.divergingPositive || techScrollTheme.palette?.accentSecondary || "#43cbff",
                techScrollTheme.palette?.divergingNegative || techScrollTheme.palette?.negative || "#ff5c8d"
            ])
            .interpolate(d3.interpolateRgb);
    
        // Create circles
        const circles = g.selectAll("circle")
            .data(top50)
            .enter()
            .append("circle")
            .attr("r", d => radiusScale(d.riskScore))
            .attr("fill", d => colorInterpolator(d.riskScore))
            .attr("stroke", "rgba(5,6,13,0.45)")
            .attr("stroke-width", 1)
            .attr("opacity", 0.9)
            .on("mouseover", function(event, d) {
                if (!d.isTop5) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 1);
                    tooltip.html(d.Title);
                }
            })
            .on("mousemove", function(event, d) {
                if (!d.isTop5) {
                    tooltip
                        .style("left", (event.clientX) + "px")
                        .style("top", (event.clientY - 80) + "px")
                        .style("transform", "translateX(-50%)");
                }
            })
            .on("mouseout", function(event, d) {
                if (!d.isTop5) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                }
            });

        // Add labels - only show on the top 5 largest circles
        const labels = g.selectAll("text")
            .data(top50)
            .enter()
            .append("text")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "middle")
            .attr("font-size", d => d.fontSize + "px")
            .attr("font-family", "'Stack Sans Notch', serif")
            .attr("fill", techScrollTextPrimary)
            .attr("font-weight", "300")
            .text(d => d.Title)
            .style("pointer-events", "none")
            .style("opacity", d => d.isTop5 ? 1 : 0);

        // Update positions on simulation tick
        simulation.on("tick", function() {
            circles
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            labels
                .attr("x", d => d.x)
                .attr("y", d => d.y);
        });

        // Add title
        svg.append("text")
            .attr("x", width / 2 + margin.left)
            .attr("y", 60)
            .attr("text-anchor", "middle")
            .attr("font-size", "16px")
            .attr("font-family", "'Stack Sans Notch', serif")
            .attr("font-weight", "300")
            .attr("fill", techScrollTextPrimary)
            .text("Job Vulnerability by risk score");

        // Add subtitle
        svg.append("text")
            .attr("x", width / 2 + margin.left)
            .attr("y", 80)
            .attr("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-family", "'Stack Sans Notch', serif")
            .attr("font-weight", "300")
            .attr("fill", techScrollTextMuted)
            .text("Larger circles show a higher risk score for AI job vulnerability");

        techJobVulnerabilityViz = { svg, g, simulation, circles, labels };
    }).catch(function(error) {
        console.error("Error loading CSV:", error);
    });
}

// ============================================================================
// SCATTER PLOT VISUALIZATION
// ============================================================================
const techScatterTheme = window.aiVizTheme || {};
const techScatterTextPrimary = techScatterTheme.palette?.textPrimary || "#f6f7ff";
const techScatterTextMuted = techScatterTheme.palette?.textMuted || "#9da7c2";
const techScatterGridColor = techScatterTheme.gridline || "rgba(255,255,255,0.12)";
let techJobVulnerabilityScatterViz = null;
let scatterData = null;

function createTechJobVulnerabilityScatter() {
    // Clear existing visualization
    d3.select("#tech-job-vulnerability-scatter").selectAll("*").remove();

    const dataPromise = scatterData ? Promise.resolve(scatterData) : d3.csv("data/Data/fig_4.2.25.csv");
    
    dataPromise.then(function(data) {
        // Parse data
        data.forEach(function(d) {
            d.riskScore = parseFloat(d.pct_occ_scaled);
            d.salary = parseFloat(d.MedianSalary);
        });

        // Cache data
        if (!scatterData) {
            scatterData = data;
        }

        // Filter out any invalid data points
        const validData = data.filter(d => !isNaN(d.riskScore) && !isNaN(d.salary));
        
        console.log(`Total jobs loaded: ${data.length}, Valid data points: ${validData.length}`);

        // Set up dimensions
        const margin = { top: 80, right: 40, bottom: 100, left: 80 };
        const baseWidth = 900;
        const width = baseWidth - margin.left - margin.right;
        const height = 650 - margin.top - margin.bottom;
        const svgWidth = baseWidth;
        const svgHeight = height + margin.top + margin.bottom;

        // Create SVG
        const svg = d3.select("#tech-job-vulnerability-scatter")
            .append("svg")
            .attr("width", "100%")
            .attr("height", svgHeight)
            .attr("viewBox", `0 0 ${svgWidth} ${svgHeight}`)
            .attr("preserveAspectRatio", "xMidYMid meet");

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("position", "fixed")
            .style("padding", "6px 10px")
            .style("border-radius", "8px")
            .style("font-size", "11px")
            .style("font-family", "'Stack Sans Notch', serif")
            .style("pointer-events", "none")
            .style("z-index", "1000");

        if (techScatterTheme.styleTooltip) {
            techScatterTheme.styleTooltip(tooltip);
        }

        // Scales
        const xScale = d3.scaleLinear()
            .domain(d3.extent(validData, d => d.riskScore))
            .range([0, width])
            .nice();

        const yScale = d3.scaleLinear()
            .domain(d3.extent(validData, d => d.salary))
            .range([height, 0])
            .nice();

        const maxRisk = d3.max(validData, d => d.riskScore);
        const minRisk = d3.min(validData, d => d.riskScore);
        const colorInterpolator = d3.scaleLinear()
            .domain([minRisk, maxRisk])
            .range([
                techScatterTheme.palette?.divergingPositive || techScatterTheme.palette?.accentSecondary || "#43cbff",
                techScatterTheme.palette?.divergingNegative || techScatterTheme.palette?.negative || "#ff5c8d"
            ])
            .interpolate(d3.interpolateRgb);

        // Add grid lines first
        g.append("g")
            .attr("class", "grid")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale)
                .ticks(8)
                .tickSize(-height)
                .tickFormat(""))
            .selectAll("line")
            .attr("stroke", techScatterGridColor)
            .attr("stroke-width", 1);

        g.append("g")
            .attr("class", "grid")
            .call(d3.axisLeft(yScale)
                .ticks(8)
                .tickSize(-width)
                .tickFormat(""))
            .selectAll("line")
            .attr("stroke", techScatterGridColor)
            .attr("stroke-width", 1);

        // Create circles
        const circles = g.selectAll("circle")
            .data(validData)
            .enter()
            .append("circle")
            .attr("cx", d => xScale(d.riskScore))
            .attr("cy", d => yScale(d.salary))
            .attr("r", 4)
            .attr("fill", d => colorInterpolator(d.riskScore))
            .attr("stroke", "rgba(5,6,13,0.45)")
            .attr("stroke-width", 0.5)
            .on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 1);
                tooltip.html(`${d.Title}<br/>Risk Score: ${d.riskScore.toFixed(2)}<br/>Salary: $${d.salary.toLocaleString()}`);
                
                d3.select(this)
                    .attr("stroke-width", 2)
                    .attr("stroke", techScatterTextPrimary)
                    .attr("r", 6);
            })
            .on("mousemove", function(event) {
                tooltip
                    .style("left", (event.clientX) + "px")
                    .style("top", (event.clientY - 80) + "px")
                    .style("transform", "translateX(-50%)");
            })
            .on("mouseout", function() {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
                
                d3.select(this)
                    .attr("stroke-width", 0.5)
                    .attr("stroke", "rgba(5,6,13,0.45)")
                    .attr("r", 4);
            });

        // Add x-axis
        const xAxis = d3.axisBottom(xScale)
            .ticks(8);

        g.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis)
            .selectAll("text")
            .attr("font-size", "11px")
            .attr("font-family", "'Stack Sans Notch', serif")
            .attr("font-weight", "300")
            .attr("fill", techScatterTextMuted);

        // Add x-axis label
        const xAxisLabel = svg.append("text")
            .attr("class", "axis-label")
            .attr("x", width / 2 + margin.left)
            .attr("y", margin.top + height + 40)
            .attr("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-family", "'Stack Sans Notch', serif")
            .attr("fill", techScatterTextPrimary);
        
        xAxisLabel.append("tspan")
            .attr("font-weight", "300")
            .text("Risk Score");
        
        xAxisLabel.append("tspan")
            .attr("font-weight", "300")
            .attr("font-style", "italic")
            .attr("fill", techScatterTextMuted)
            .text(" (Higher risk score means more vulnerable)");

        // Add y-axis
        const yAxis = d3.axisLeft(yScale)
            .ticks(8)
            .tickFormat(d => "$" + (d / 1000) + "K");

        g.append("g")
            .attr("class", "y-axis")
            .call(yAxis)
            .selectAll("text")
            .attr("font-size", "11px")
            .attr("font-family", "'Stack Sans Notch', serif")
            .attr("font-weight", "300")
            .attr("fill", techScatterTextMuted);

        g.select(".y-axis").select(".domain")
            .attr("stroke", "none");

        g.append("text")
            .attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("y", -60)
            .attr("x", -height / 2)
            .attr("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-family", "'Stack Sans Notch', serif")
            .attr("font-weight", "300")
            .attr("fill", techScatterTextPrimary)
            .text("Median Salary");

        // Add title
        svg.append("text")
            .attr("x", width / 2 + margin.left)
            .attr("y", 30)
            .attr("text-anchor", "middle")
            .attr("font-size", "16px")
            .attr("font-family", "'Stack Sans Notch', serif")
            .attr("font-weight", "300")
            .attr("fill", techScatterTextPrimary)
            .text("Job Vulnerability and Salary");

        techJobVulnerabilityScatterViz = { svg, g, xScale, yScale, circles };
    }).catch(function(error) {
        console.error("Error loading CSV:", error);
    });
}

// ============================================================================
// INITIALIZATION
// ============================================================================
// Initialize on load
$(document).ready(function() {
    setTimeout(function() {
        createTechJobVulnerability();
        createTechJobVulnerabilityScatter();
    }, 500);
});

